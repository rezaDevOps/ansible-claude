---
# Playbook to provision AWS EC2 instance
# Run with: ansible-playbook -i inventory/localhost.ini playbooks/provision.yml

- name: Provision AWS EC2 Instance
  hosts: local
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Ensure boto3 and botocore are installed
      ansible.builtin.pip:
        name:
          - boto3
          - botocore
        state: present
      delegate_to: localhost
      run_once: true

    - name: Check if EC2 key pair exists in AWS
      amazon.aws.ec2_key_info:
        region: "{{ aws_region }}"
        names:
          - "{{ aws_keypair_name }}"
      register: key_pair_check
      ignore_errors: true

    - name: Create EC2 key pair in AWS if it doesn't exist
      amazon.aws.ec2_key:
        name: "{{ aws_keypair_name }}"
        region: "{{ aws_region }}"
        state: present
      register: ec2_key_result
      when: key_pair_check.keypairs | length == 0

    - name: Save private key to file if new key was created (local only)
      ansible.builtin.copy:
        content: "{{ ec2_key_result.key.private_key }}"
        dest: "{{ playbook_dir }}/../ansible-ec2-key-NEW.pem"
        mode: '0600'
      delegate_to: localhost
      when:
        - ec2_key_result.changed | default(false)
        - ec2_key_result.key.private_key is defined
        - lookup('env', 'CI') == ''  # Only save locally, not in CI

    - name: Display IMPORTANT message if new key was created
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "⚠️  NEW SSH KEY PAIR CREATED!"
          - "=========================================="
          - "Key name: {{ aws_keypair_name }}"
          - "Private key saved to: {{ playbook_dir }}/../ansible-ec2-key-NEW.pem"
          - ""
          - "IMPORTANT: You must update GitHub Secret 'SSH_PRIVATE_KEY'"
          - "Run: cat {{ playbook_dir }}/../ansible-ec2-key-NEW.pem"
          - "Copy the content to GitHub Repository Secrets as SSH_PRIVATE_KEY"
          - "=========================================="
      when:
        - ec2_key_result.changed | default(false)
        - lookup('env', 'CI') == ''

    - name: Display key pair status
      ansible.builtin.debug:
        msg: "✓ Using existing EC2 key pair: {{ aws_keypair_name }}"
      when: key_pair_check.keypairs | length > 0

    - name: Get latest Ubuntu 22.04 AMI
      amazon.aws.ec2_ami_info:
        region: "{{ aws_region }}"
        owners: "{{ ami_owner }}"
        filters:
          name: "{{ ami_name_filter }}"
          state: available
          architecture: x86_64
          root-device-type: ebs
          virtualization-type: hvm
      register: ami_info

    - name: Set AMI ID to latest
      ansible.builtin.set_fact:
        ami_id: "{{ ami_info.images | sort(attribute='creation_date') | last | community.general.json_query('image_id') }}"

    - name: Display selected AMI
      ansible.builtin.debug:
        msg: "Using AMI: {{ ami_id }}"

    - name: Create security group
      amazon.aws.ec2_security_group:
        name: "{{ security_group_name }}"
        description: "{{ security_group_description }}"
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id | default(omit) }}"
        rules:
          # SSH access
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: "{{ allowed_ssh_ips }}"
            rule_desc: "SSH access"
          # HTTP access
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: "0.0.0.0/0"
            rule_desc: "HTTP access"
          # HTTPS access
          - proto: tcp
            from_port: 443
            to_port: 443
            cidr_ip: "0.0.0.0/0"
            rule_desc: "HTTPS access"
        rules_egress:
          # Allow all outbound traffic
          - proto: -1
            from_port: -1
            to_port: -1
            cidr_ip: "0.0.0.0/0"
        tags: "{{ instance_tags }}"
      register: security_group

    - name: Launch EC2 instance
      amazon.aws.ec2_instance:
        name: "{{ instance_tags.Name }}"
        region: "{{ aws_region }}"
        key_name: "{{ aws_keypair_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ ami_id }}"
        security_group: "{{ security_group_name }}"
        vpc_subnet_id: "{{ subnet_id | default(omit) }}"
        network:
          assign_public_ip: true
        wait: yes
        wait_timeout: 300
        state: running
        tags: "{{ instance_tags }}"
        volumes:
          - device_name: /dev/sda1
            ebs:
              volume_size: 8
              volume_type: gp3
              delete_on_termination: true
      register: ec2_instance

    - name: Wait for instance to be running
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for instance to initialize..."

    - name: Display instance information
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "EC2 Instance provisioned successfully!"
          - "=========================================="
          - "Instance ID: {{ ec2_instance.instances[0].instance_id }}"
          - "Public IP: {{ ec2_instance.instances[0].public_ip_address }}"
          - "Private IP: {{ ec2_instance.instances[0].private_ip_address }}"
          - "State: {{ ec2_instance.instances[0].state.name }}"
          - ""
          - "NEXT STEPS:"
          - "1. Update inventory/hosts.ini with the Public IP above"
          - "2. Wait 30-60 seconds for SSH to be available"
          - "3. Test SSH: ssh -i {{ local_ssh_private_key }} ubuntu@{{ ec2_instance.instances[0].public_ip_address }}"
          - "4. Run: ansible-playbook -i inventory/hosts.ini playbooks/site.yml --private-key {{ local_ssh_private_key }}"
          - "=========================================="

    - name: Save instance info to file
      ansible.builtin.copy:
        content: |
          # EC2 Instance Information
          # Generated: {{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%S') }}

          Instance ID: {{ ec2_instance.instances[0].instance_id }}
          Public IP: {{ ec2_instance.instances[0].public_ip_address }}
          Private IP: {{ ec2_instance.instances[0].private_ip_address }}
          Region: {{ aws_region }}
          Instance Type: {{ instance_type }}
          AMI ID: {{ ami_id }}
          Key Pair: {{ aws_keypair_name }}
          Security Group: {{ security_group_name }}

          SSH Command:
          ssh -i {{ local_ssh_private_key }} ubuntu@{{ ec2_instance.instances[0].public_ip_address }}

          Update inventory/hosts.ini with this IP:
          {{ ec2_instance.instances[0].public_ip_address }}
        dest: "{{ playbook_dir }}/../ec2_instance_info.txt"
      delegate_to: localhost
